# Godot Import Plugin Roadmap

This document outlines the plan for developing a Godot Engine plugin to seamlessly import sprite sheets generated by the Paper Sprite Pipeline. The goal is to automate the process of setting up 2D animated sprites with proper normal mapping within Godot projects.

## 1. Purpose of This Plugin

The Paper Sprite Pipeline exports 3D models as a series of 2D sprite sheets, complete with animation frames and separate normal maps. Manually importing these into Godot, setting up animations, and configuring materials for normal mapping can be time-consuming and error-prone.

This plugin will:
*   Read the `metadata.json` file generated by the Paper Sprite Pipeline.
*   Automatically create Godot resources (like `SpriteFrames` and `Material`s).
*   Set up all animations, including frame timings and sprite sheet regions.
*   Configure normal maps for realistic lighting effects in 2D.
*   Provide a user-friendly interface within the Godot editor for the import process.

## 2. Why a Godot Editor Plugin?

Godot Engine offers a robust plugin system that allows developers to extend its editor functionality. Building this as an editor plugin provides several key advantages over a standalone script:

*   **Seamless Integration:** The import process will feel like a native part of Godot, accessible directly from the editor.
*   **Automated Workflow:** It can automatically detect and process `metadata.json` files when they are added to a Godot project.
*   **User Interface:** Custom user interfaces can be built within the Godot editor to provide options and feedback during import.
*   **Direct Resource Creation:** The plugin can directly create and save Godot-specific resource files (e.g., `.tres` files) into your project.

## 3. Core Functionality Overview

The plugin will primarily focus on converting the exported sprite sheet data into usable Godot assets.

### Import Modes

The plugin will support two primary import modes, allowing flexibility in how the sprites are used in Godot:

1.  **2D Import Mode:**
    *   **Purpose:** For traditional 2D games where sprites are rendered directly onto a 2D canvas.
    *   **Material:** Will create and configure a `CanvasItemMaterial` for the sprite, assigning the diffuse texture and the normal map (for 2D lighting effects).
    *   **Node:** Typically used with `Sprite2D` or `AnimatedSprite2D` nodes.

2.  **3D Import Mode (2.5D/Billboard):**
    *   **Purpose:** For games that use 2D sprites within a 3D environment, often referred to as 2.5D or billboard sprites. This allows for 3D lighting and perspective effects on 2D assets.
    *   **Material:** Will create and configure a `StandardMaterial3D` (or similar 3D material) that applies the diffuse texture and the normal map to a plane or billboard mesh.
    *   **Node:** Typically used with `MeshInstance3D` nodes with a plane mesh, or custom billboard shaders.

### Common Functionality Across Modes

Regardless of the chosen import mode, the plugin will perform the following core tasks:

*   **Metadata Parsing:** Read and interpret the `metadata.json` file.
*   **Texture Loading:** Load the generated diffuse and normal map sprite sheet images.
*   **SpriteFrames Resource Creation:** Generate a `SpriteFrames` resource, which is Godot's way of managing 2D animation frames (relevant for both 2D and 3D modes if using `AnimatedSprite3D` or similar).
*   **Animation Setup:** For each animation defined in the metadata, create a corresponding animation in the `SpriteFrames` resource, defining its frames, their positions on the sprite sheet, and their durations.
*   **Scene Instantiation (Optional):** Provide an option to automatically create a pre-configured node (e.g., `Sprite2D` or `MeshInstance3D`) in the current scene.

## 4. Metadata Requirements

The `metadata.json` file is the primary input for this plugin. It contains all the necessary information about the exported sprite sheets.

A typical `metadata.json` structure will look like this:

```json
{
  "fps": 24,
  "frameDimensions": {
    "width": 1024,
    "height": 1024
  },
  "passes": ["normal", "diffuse"],
  "actions": [
    {
      "name": "action_name",
      "sprites": [
        {
          "x": 0,
          "y": 0,
          "frames": 1
        },
        {
          "x": 1024,
          "y": 0,
          "frames": 2
        }
      ]
    }
  ]
}
```

### Current Metadata Fields and Their Use in Godot

The existing fields in `metadata.json` are highly valuable for the Godot import process:

*   `fps`: Directly maps to Godot's `Animation` speed, ensuring animations play at the correct rate.
*   `frameDimensions`: The `width` and `height` of each individual sprite frame on the sheet. This is crucial for defining the `Rect2` (region) of each frame when creating `SpriteFrames` resources in Godot.
*   `passes`: A list of strings indicating the types of image passes exported (e.g., "diffuse" for color, "normal" for normal maps). This tells the plugin which image files to look for (e.g., `diffuse.png`, `normal.png`) and how to interpret them for material setup.
*   `actions`: An array, where each entry represents a distinct animation.
    *   `name`: The name of the animation (e.g., "idle", "walk"). This will be used directly as the animation name in Godot's `SpriteFrames` resource.
    *   `sprites`: An array of objects, each defining a single frame within that animation.
        *   `x`, `y`: The pixel coordinates (top-left corner) of the frame on the sprite sheet. These are used to calculate the `Rect2` for each frame.
        *   `frames`: The duration of this frame in terms of original animation frames. This is essential for handling optimized animations (where identical frames are skipped). Godot's `Animation` system allows setting a `duration` for each frame, so a `frames` value of `2` would mean the frame lasts for two `fps` intervals (`2 / fps` seconds).

### Potential Metadata Improvements for Enhanced Godot Integration

While the current `metadata.json` is sufficient for a basic import, the following additions would significantly enhance the Godot plugin's capabilities and robustness:

1.  **Explicit Sprite Sheet Paths:**
    *   **Current:** The plugin infers sprite sheet paths based on a predefined folder structure (e.g., `<output_folder>/<action_name>/camera_<n>/<pass_name>.<extension>`).
    *   **Improvement:** Include explicit, relative paths to each generated sprite sheet (diffuse, normal, etc.) directly within the `metadata.json`.
    *   **Benefit:** Makes the import tool more robust and less dependent on a rigid folder structure. It simplifies file loading logic within Godot.

2.  **Camera Angles:**
    *   **Current:** Camera angles are used during the Blender export process but are not explicitly stored in the `metadata.json` for each `camera_<n>` output.
    *   **Improvement:** Add the exact angle (in degrees or radians) for each `camera_<n>` output to the metadata.
    *   **Benefit:** Enables advanced 2.5D effects in Godot. For example, a game could dynamically swap between different camera angle sprites based on a 3D object's rotation, creating a pseudo-3D effect from 2D assets.

3.  **Object Name:**
    *   **Current:** The object's name is implied by the folder structure (e.g., `output_folder/<object_name>/...`).
    *   **Improvement:** Include the original Blender object's name explicitly in the metadata.
    *   **Benefit:** Provides clearer context within Godot, especially if the import process creates resources named after the original object.

4.  **`grid_cols` and `grid_rows`:**
    *   **Current:** The grid layout (number of columns and rows in the sprite sheet) is implicitly defined by the `x` and `y` coordinates of the `sprites` and the `frameDimensions`.
    *   **Improvement:** Explicitly include `grid_cols` and `grid_rows` in the metadata.
    *   **Benefit:** Can simplify some calculations within the Godot plugin and provide useful information for debugging or custom rendering logic.

These potential additions would require corresponding updates to the Blender export script to include this information in the `metadata.json` file. The Godot plugin would then be designed to leverage these new fields if they are present.

## 5. Technical Steps / Milestones

This section outlines the development milestones for the Godot Import Plugin, focusing on getting it working.

### Milestone 1: Basic Plugin Setup & Metadata Parsing

1.  **Create Godot Project:** Set up a new Godot project for plugin development.
2.  **Initialize Editor Plugin:** Create the basic `plugin.gd` script and configure it as an `EditorPlugin`.
3.  **File System Monitoring:** Implement basic file system monitoring to detect when `metadata.json` files are added to the project.
4.  **Metadata Loading:** Read the `metadata.json` file and parse its contents into a Godot Dictionary or custom data structure.
5.  **Basic Output:** Print the parsed metadata to Godot's output console for verification.

### Milestone 2: Texture Loading & SpriteFrames Creation

1.  **Load Diffuse Texture:** Based on `frameDimensions` and `passes`, load the main diffuse sprite sheet image (`<action_name>/camera_<n>/diffuse.png`) as a Godot `Texture2D` resource.
2.  **Create SpriteFrames Resource:** Instantiate a new `SpriteFrames` resource.
3.  **Add Animations:** Iterate through the `actions` in the metadata. For each action, add a new animation to the `SpriteFrames` resource using its `name` and `fps`.
4.  **Add Frames to Animations:** For each `sprite` entry within an action, calculate its `Rect2` (region on the sprite sheet) using `x`, `y`, `frameDimensions.width`, and `frameDimensions.height`. Add this frame to the corresponding animation in the `SpriteFrames` resource.
5.  **Handle Frame Durations:** Use the `frames` property from the metadata to set the duration of each frame in the Godot animation.

### Milestone 3: Normal Map Integration

1.  **Load Normal Map Texture:** Load the normal map sprite sheet image (`<action_name>/camera_<n>/normal.png`) as a Godot `Texture2D` resource.
2.  **Create CanvasItemMaterial:** Instantiate a new `CanvasItemMaterial` resource.
3.  **Assign Normal Map:** Set the `normal_map` property of the `CanvasItemMaterial` to the loaded normal map texture.
4.  **Apply Material:** Ensure that when a `Sprite2D` node uses the generated `SpriteFrames`, it also uses this `CanvasItemMaterial`. This might involve creating a custom scene or providing an option to apply the material to existing `Sprite2D` nodes.

### Milestone 4: Editor Integration & User Experience

1.  **Custom Importer (Advanced):** Register a custom importer for `.metadata.json` files. This will allow users to simply drag and drop the `metadata.json` into Godot, and the plugin will automatically process it.
2.  **Import Dialog/Options:** If a custom importer is not used, create a custom editor UI (e.g., a button in the toolbar or a dock) to trigger the import process and allow users to select the `metadata.json` file.
3.  **Error Handling & Feedback:** Implement robust error handling for missing files, invalid metadata, etc., and provide clear feedback to the user through Godot's editor console or pop-up messages.
4.  **Resource Saving:** Ensure all generated Godot resources (`.tres` files) are saved correctly to the project's file system.

### Milestone 5: Refinement

1.  **Testing:** Thoroughly test the plugin with various sprite sheets, animation counts, and pass configurations.
2.  **Documentation:** Write clear documentation for users on how to install and use the plugin.
3.  **Advanced Features (Future):**
    *   Support for other passes (specular, depth, etc.).
    *   Options for different material types or shader configurations.
    *   Integration with Godot's 3D environment for 2.5D effects (using the camera angle metadata).

By following these steps, we can build a powerful and user-friendly Godot import plugin for the Paper Sprite Pipeline.
